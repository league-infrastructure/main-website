---
export interface Props {
  meetupGroup?: string;
  class?: string;
}

const { meetupGroup = 'the-league-tech-club', class: className } = Astro.props;
const elementId = `upcoming-events-${Math.random().toString(36).substr(2, 9)}`;
---

<div 
  id={elementId} 
  class={`jtl-schedule-root ${className || ''}`}
  data-meetup-group={meetupGroup}
>
  <div class="schedule-container">
    <div class="upcoming-events__loading">
      <p>Loading upcoming events...</p>
    </div>
  </div>
</div>

<style>
  .jtl-schedule-root {
    margin-top: var(--space-xl);
  }

  .schedule-container {
    display: grid;
    gap: var(--space-lg);
  }

  .upcoming-events__loading,
  .upcoming-events__error,
  .upcoming-events__empty {
    text-align: center;
    padding: var(--space-2xl);
    color: var(--color-body);
  }

  .upcoming-events__error {
    color: var(--color-error, #dc2626);
  }

  /* Match the class-box structure from the live site */
  .class-box {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-card);
    padding: var(--space-xl);
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .class-box .name {
    font-size: 20px;
    font-weight: 600;
    color: var(--color-text);
    margin: 0;
    line-height: 1.3;
  }

  .details-container {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .details {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .time {
    color: var(--color-body);
    font-size: 14px;
  }

  .location {
    color: var(--color-body);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }

  .location i {
    color: var(--color-primary);
    width: 16px;
  }

  .enroll-button {
    margin-top: var(--space-sm);
  }

  .enroll-button button {
    padding: 10px 20px;
    background: var(--color-primary);
    color: #ffffff;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .enroll-button button:hover {
    background: var(--color-primary-dark);
  }

  @media (min-width: 600px) {
    .details-container {
      flex-direction: row;
      justify-content: space-between;
      align-items: flex-start;
    }

    .details {
      flex: 1;
    }

    .enroll-button {
      margin-top: 0;
      align-self: center;
    }
  }

  @media (max-width: 600px) {
    .class-box {
      padding: var(--space-lg);
    }
  }
</style>

<script>
  (function() {
    interface Event {
      id: string;
      title: string;
      dateTime: string;
      description: string;
      eventUrl: string;
      status: string;
      venues: Array<{ id: string; name: string }>;
      eventHosts: Array<{ name: string }>;
      venue: { id: string; name: string };
    }

    function escapeHtml(text: string): string {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateTime: string): string {
      const date = new Date(dateTime);
      const weekday = date.toLocaleDateString('en-US', { weekday: 'short' });
      const month = date.toLocaleDateString('en-US', { month: 'long' });
      const day = date.getDate();
      const time = date.toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
      });
      // Format as "Sun, November 2 at 11:30 AM" (matching the live site format)
      return `${weekday}, ${month} ${day} at ${time}`;
    }

    function renderEvents(container: Element, events: Event[]) {
      const html = events.map(event => `
        <div class="class-box">
          <div class="name" style="font-size: 20px;">
            ${escapeHtml(event.title)}
          </div>
          <div class="details-container">
            <div class="details">
              <div class="time">
                ${formatDate(event.dateTime)}
              </div>
              ${event.venue ? `
                <div class="location">
                  <i class="fas fa-map-marker-alt"></i>
                  ${escapeHtml(event.venue.name)}
                </div>
              ` : ''}
            </div>
            <div class="enroll-button">
              <button onclick="window.open('${event.eventUrl}', '_blank')">
                Enroll
              </button>
            </div>
          </div>
        </div>
      `).join('');
      
      container.innerHTML = html;
      
      // Load Font Awesome for the location icons if not already loaded
      if (!document.querySelector('link[href*="font-awesome"]')) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css';
        link.integrity = 'sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==';
        link.crossOrigin = 'anonymous';
        document.head.appendChild(link);
      }
    }

    function renderEmpty(container: Element) {
      container.innerHTML = `
        <div class="upcoming-events__empty">
          <p>No upcoming events scheduled at this time.</p>
          <p>Check back soon or <a href="https://www.meetup.com/the-league-tech-club/" target="_blank" rel="noopener">visit our Meetup page</a> for the latest schedule.</p>
        </div>
      `;
    }

    function renderError(container: Element) {
      container.innerHTML = `
        <div class="upcoming-events__error">
          <p>Failed to load upcoming events. Please try again later.</p>
          <p><a href="https://www.meetup.com/the-league-tech-club/" target="_blank" rel="noopener">Visit our Meetup page</a> for the latest schedule.</p>
        </div>
      `;
    }

    async function loadEvents(element: Element) {
      const meetupGroup = element.getAttribute('data-meetup-group') || 'the-league-tech-club';
      const container = element.querySelector('.schedule-container');
      if (!container) return;
      
      try {
        const response = await fetch('https://snips.jtlapp.net/leaguesync/meetups.json');
        if (!response.ok) {
          throw new Error(`Failed to load events: ${response.status}`);
        }
        
        const data: Record<string, Event[]> = await response.json();
        const events = data[meetupGroup] || [];

        if (events.length === 0) {
          renderEmpty(container);
          return;
        }

        // Filter to only ACTIVE events and sort by date
        const activeEvents = events
          .filter(event => event.status === 'ACTIVE')
          .sort((a, b) => new Date(a.dateTime).getTime() - new Date(b.dateTime).getTime());

        if (activeEvents.length === 0) {
          renderEmpty(container);
          return;
        }

        renderEvents(container, activeEvents);
      } catch (error) {
        console.error('Error loading upcoming events:', error);
        renderError(container);
      }
    }

    // Initialize on page load
    function initialize() {
      document.querySelectorAll('.jtl-schedule-root[data-meetup-group]').forEach((element) => {
        if (!element.hasAttribute('data-loaded')) {
          element.setAttribute('data-loaded', 'true');
          loadEvents(element);
        }
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initialize);
    } else {
      initialize();
    }
  })();
</script>