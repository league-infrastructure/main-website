---
import Section from "./Section.astro";
import SectionHeader from "./SectionHeader.astro";
import { pike13_base_url, pike13_client_id } from "../content/config";
import locationsData from "../data/locations.json";
import occurrencesScript from "../scripts/pike13-occurrences.ts?url";

interface Props {
  serviceIds?: Array<number | string>;
  heading?: string | null;
  limit?: number;
}

const { serviceIds = [], heading = "Upcoming Sessions", limit } =
  Astro.props as Props;

function normalizeServiceIds(values: Array<number | string>): number[] {
  return Array.from(
    new Set(
      values
        .map((value) => {
          if (typeof value === "number" && Number.isFinite(value)) {
            return Math.trunc(value);
          }
          if (typeof value === "string") {
            const trimmed = value.trim();
            if (trimmed.length === 0) {
              return null;
            }
            const parsed = Number.parseInt(trimmed, 10);
            if (Number.isFinite(parsed)) {
              return Math.trunc(parsed);
            }
          }
          return null;
        })
        .filter((value): value is number => value !== null && value > 0),
    ),
  ).sort((a, b) => a - b);
}

const normalizedIds = normalizeServiceIds(serviceIds ?? []);
const baseUrlRaw = typeof pike13_base_url === "string" ? pike13_base_url.trim() : "";
const baseUrl = baseUrlRaw.replace(/\/$/, "");
const clientId = typeof pike13_client_id === "string" ? pike13_client_id.trim() : "";

const locationMap = Object.fromEntries(
  (locationsData as Array<{ id?: number; name?: string }>)
    .filter((entry) => entry && typeof entry.id === "number")
    .map((entry) => {
      const name = typeof entry.name === "string" && entry.name.trim().length > 0
        ? entry.name.trim()
        : "Location To Be Announced";
      return [String(entry.id), name];
    }),
);

const shouldRender = normalizedIds.length > 0 && baseUrl.length > 0;
const serviceIdsJson = JSON.stringify(normalizedIds);
const locationsJson = JSON.stringify(locationMap);
const limitValue =
  typeof limit === "number" && Number.isFinite(limit) && limit > 0
    ? String(Math.trunc(limit))
    : undefined;

const statusText = "Loading upcoming sessionsâ€¦";
---
{shouldRender ? (
  <Section
    class="pike13-occurrences"
    data-component="pike13-occurrences"
    data-service-ids={serviceIdsJson}
    data-base-url={baseUrl}
    data-client-id={clientId}
    data-locations={locationsJson}
    data-limit={limitValue}
  >
    {heading !== null && (
      <SectionHeader>
        <h3>{heading}</h3>
      </SectionHeader>
    )}
    <div class="pike13-occurrences__status" data-role="status">{statusText}</div>
    <ul class="pike13-occurrences__list" data-role="list" hidden></ul>
    <script is:inline type="module" src={occurrencesScript}></script>
  </Section>
) : null}

<style>
  .pike13-occurrences {
    margin-top: var(--space-xl);
  }

  .pike13-occurrences__list {
    list-style: none;
    display: grid;
    gap: var(--space-lg);
    padding: 0;
    margin: 0;
  }

  .pike13-occurrences__item {
    display: grid;
    gap: var(--space-sm);
  }

  .pike13-occurrences__name {
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0;
  }

  .pike13-occurrences__meta {
    margin: 0;
    color: var(--color-muted);
    font-size: 0.95rem;
  }

  .pike13-occurrences__label {
    font-weight: 600;
  }
</style>
