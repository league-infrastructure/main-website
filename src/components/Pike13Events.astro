---
import Section from "./Section.astro";
import SectionHeader from "./SectionHeader.astro";
import { pike13_base_url, pike13_client_id } from "../content/config";
import eventsScript from "../scripts/pike13-events.ts?url";

interface Props {
  serviceId?: number | string | null;
  serviceIds?: Array<number | string | null>;
  heading?: string | null;
}

const { serviceId = null, serviceIds = [], heading = "Pike13 Debug" } = Astro.props as Props;

const normalizedId = (() => {
  const candidates: Array<number | string | null> = [];
  candidates.push(serviceId);
  if (Array.isArray(serviceIds)) {
    candidates.push(...serviceIds);
  }

  for (const candidate of candidates) {
    if (typeof candidate === "number" && Number.isFinite(candidate)) {
      return Math.trunc(candidate);
    }
    if (typeof candidate === "string") {
      const parsed = Number.parseInt(candidate.trim(), 10);
      if (Number.isFinite(parsed)) {
        return Math.trunc(parsed);
      }
    }
  }

  return null;
})();

const baseUrl = typeof pike13_base_url === "string" ? pike13_base_url.replace(/\/$/, "").trim() : "";
const clientId = typeof pike13_client_id === "string" ? pike13_client_id.trim() : "";

const shouldRender = normalizedId !== null && baseUrl.length > 0;
const serviceIdJson = JSON.stringify(normalizedId);
---
{shouldRender ? (
  <Section
    class="pike13-events-debug"
    data-component="pike13-events-debug"
    data-service-id={serviceIdJson}
    data-base-url={baseUrl}
    data-client-id={clientId}
  >
    {heading !== null && (
      <SectionHeader>
        <h3>{heading}</h3>
      </SectionHeader>
    )}
    <div class="pike13-events-debug__row">
      <div class="pike13-events-debug__column">
        <h4>Service Response</h4>
        <pre data-role="service">Loading…</pre>
      </div>
      <div class="pike13-events-debug__column">
        <h4>Events Response</h4>
        <pre data-role="events">Loading…</pre>
      </div>
    </div>
    <script is:inline type="module" src={eventsScript}></script>
  </Section>
) : null}

<style>
  .pike13-events-debug__row {
    display: grid;
    gap: var(--space-lg);
  }

  @media (min-width: 48rem) {
    .pike13-events-debug__row {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  .pike13-events-debug__column {
    display: grid;
    gap: var(--space-sm);
  }

  .pike13-events-debug__column pre {
    margin: 0;
    padding: var(--space-md);
    background-color: var(--color-surface-muted);
    border-radius: var(--radius-md);
    overflow: auto;
    max-height: 24rem;
    font-size: 0.85rem;
    line-height: 1.4;
  }
</style>
