---
import type { GetStaticPathsResult } from "astro";
import ProgramLayout from "../../layouts/ProgramLayout.astro";
import HeroSection from "../../components/HeroSection.astro";
import Section from "../../components/Section.astro";
import SectionHeader from "../../components/SectionHeader.astro";
import ClassCard from "../../components/ClassCard.astro";
import CalloutCard from "../../components/CalloutCard.astro";
import ButtonGroup from "../../components/ButtonGroup.astro";
import { marked } from "marked";
import {
  getProgramsData,
  getClassesData,
  getCategoriesData,
  getStructuredContent,
  getForCategoryList,
} from "../../utils/markdown.js";
import type { StructuredContentRecord, StructuredCta } from "../../types/content";

interface RouteProps {
  programData: StructuredContentRecord;
  relatedClasses: StructuredContentRecord[];
  categoryData: StructuredContentRecord[];
  enrollmentGuide?: StructuredContentRecord;
}

export async function getStaticPaths(): Promise<GetStaticPathsResult> {
  const programs = getProgramsData();
  const classes = getClassesData();
  const categories = getCategoriesData();
  const contentEntries = getStructuredContent("content") as StructuredContentRecord[];
  const enrollmentGuides = contentEntries.filter(
    (entry) => entry.slug === "enrollment-instructions",
  );
  return programs
    .map((entry) => {
      const slug = entry.slug;
      if (!slug) {
        return undefined;
      }

      const classSlugs = entry.classes ?? [];
      const relatedClasses = classSlugs
        .map((classSlug: string) =>
          classes.find((classItem) => classItem.slug === classSlug),
        )
        .filter(Boolean) as StructuredContentRecord[];

      const rawCategorySlugs = Array.isArray(entry.category) ? entry.category : [];

      const categorySlugs = rawCategorySlugs
        .map((categorySlug: string) =>
          typeof categorySlug === "string" && categorySlug.trim().length > 0
            ? categorySlug.trim()
            : undefined,
        )
        .filter((value: string | undefined): value is string => typeof value === "string" && value.length > 0);

      const matchedCategories = categorySlugs
        .map((categorySlug: string) =>
          categories.find((categoryEntry) => categoryEntry.slug === categorySlug),
        )
        .filter(Boolean) as StructuredContentRecord[];
      const enrollmentGuide = enrollmentGuides.find((guide) => {
        if (categorySlugs.length === 0) {
          return false;
        }
        const guideCategories = getForCategoryList(guide);
        return guideCategories.some((category) => categorySlugs.includes(category));
      });

      return {
        params: { slug },
        props: {
          programData: entry,
          relatedClasses,
          categoryData: matchedCategories,
          enrollmentGuide,
        },
      };
    })
    .filter(Boolean) as GetStaticPathsResult;
}

const { programData, relatedClasses, categoryData, enrollmentGuide: enrollmentGuideRecord } =
  Astro.props as unknown as RouteProps;

const programSlug = programData.slug;

if (!programData || !programSlug) {
  throw new Error("Program data not found for requested slug");
}

const heroImageSource = programData.image;
const heroImage = heroImageSource
  ? `/images/cards/${heroImageSource}`
  : "/images/cards/programs.png";
const heroAlt = programData.title ?? "Program hero";
const heroDescription = programData.blurb ?? programData.description;
const descriptionText =
  programData.description || programData.blurb || "";
const descriptionParagraphs = descriptionText
  .split(/\n\s*\n/)
  .map((paragraph) => paragraph.trim())
  .filter((paragraph) => paragraph.length > 0);
const topics = programData.topics ?? [];
const hasContent = Boolean(programData.content && programData.content.trim().length > 0);
const renderedContent = hasContent ? await marked.parse(programData.content ?? "") : undefined;
const programEnrollContent =
  typeof programData.enroll === "string" ? programData.enroll.trim() : "";
const categoryEntries = Array.isArray(categoryData) ? categoryData : [];
const categoryEnrollSections = categoryEntries
  .map((entry) => (typeof entry.enroll === "string" ? entry.enroll.trim() : ""))
  .filter((content) => content.length > 0);
const categoryCtas = categoryEntries.flatMap((entry) => (Array.isArray(entry.cta) ? entry.cta : []));
const sanitizedCategoryCtas = categoryCtas.filter(
  (action): action is StructuredCta => Boolean(action?.label && action?.url),
);
const programCtas = Array.isArray(programData.cta)
  ? (programData.cta as StructuredCta[])
  : [];
const sanitizedProgramCtas = programCtas.filter(
  (action): action is StructuredCta => Boolean(action?.label && action?.url),
);
const resolvedCtas =
  sanitizedProgramCtas.length > 0 ? sanitizedProgramCtas : sanitizedCategoryCtas;
const effectiveEnrollContent =
  programEnrollContent || categoryEnrollSections.find((content) => content.length > 0) || "";
const hasEnrollSection = Boolean(effectiveEnrollContent) || resolvedCtas.length > 0;
const enrollmentGuideTitle = enrollmentGuideRecord?.title ?? "Enrollment Instructions";
const enrollmentGuideHtml = enrollmentGuideRecord?.content
  ? await marked.parse(enrollmentGuideRecord.content)
  : undefined;
const enrollmentGuidePrimaryCta = Array.isArray(enrollmentGuideRecord?.cta)
  ? (enrollmentGuideRecord?.cta.find((action) => action?.label && action?.url) as
      | StructuredCta
      | undefined)
  : undefined;
const enrollmentGuideCta = enrollmentGuidePrimaryCta
  ? {
      label: enrollmentGuidePrimaryCta.label ?? "Learn more",
      href: enrollmentGuidePrimaryCta.url ?? "#",
      variant: (enrollmentGuidePrimaryCta.variant as "primary" | "secondary" | "outline" | "ghost")
        ?? "secondary",
      target: enrollmentGuidePrimaryCta.target,
      rel: enrollmentGuidePrimaryCta.rel,
    }
  : undefined;
const showEnrollmentGuide = Boolean(enrollmentGuideHtml);
---

<ProgramLayout
  title={programData.title}
  description={heroDescription ?? programData.description}
>
  <HeroSection slot="hero" class="program-hero">
    <h1 slot="tagline">{programData.title}</h1>
    {(heroDescription || topics.length > 0) && (
      <div slot="description" class="program-hero__description">
        {heroDescription && <p class="program-hero__lead">{heroDescription}</p>}
        {topics.length > 0 && (
          <div class="program-hero__topics">
            {topics.map((topic: string) => (
              <span class="topic-pill">{topic}</span>
            ))}
          </div>
        )}
      </div>
    )}
    <div slot="media" class="program-hero__media">
      <img src={heroImage} alt={`${heroAlt} illustration`} loading="eager" />
    </div>
  </HeroSection>

  <Section startBgcolor="var(--color-surface)" endBgcolor="var(--color-surface-alt)">
    <SectionHeader>
      <h2>Program Overview</h2>
    </SectionHeader>

    <div class="program-content">
      {renderedContent ? (
        <div class="program-content__body" set:html={renderedContent} />
      ) : descriptionParagraphs.length > 0 ? (
        descriptionParagraphs.map((paragraph) => <p>{paragraph}</p>)
      ) : (
        <p>Additional program details will be published soon.</p>
      )}
    </div>
  </Section>

  {relatedClasses.length > 0 && (
    <Section startBgcolor="var(--color-surface-alt)" endBgcolor="var(--color-primary-soft)">
      <SectionHeader>
        <h2>Classes in this Program</h2>
        <p>Explore the classes that are part of this program pathway.</p>
      </SectionHeader>

      <div class="program-classes">
        {relatedClasses
          .map((classItem) => {
            const classSlug = classItem.slug;
            const classImage = classItem.image;
            const classLevel = classItem.level;

            if (!classSlug || !classImage) {
              console.warn(`Related class "${classItem.title}" is missing slug or image.`);
              return null;
            }

            return (
              <ClassCard
                img={`/images/cards/${classImage}`}
                alt={classItem.title}
                slug={classSlug}
                title={classItem.title}
                level={classLevel}
                description={classItem.blurb ?? classItem.description ?? ""}
              />
            );
          })
          .filter(Boolean)}
      </div>
    </Section>
  )}

  {hasEnrollSection && (
    <Section
      startBgcolor="var(--color-surface-alt)"
      endBgcolor="var(--color-primary-soft)"
      class="program-enroll-section"
    >
      <SectionHeader>
        <h2>How to Enroll</h2>
      </SectionHeader>

      <div class={`program-enroll${showEnrollmentGuide && enrollmentGuideHtml ? " program-enroll--with-guide" : ""}`}>
        <div class="program-enroll__primary">
          {effectiveEnrollContent && (
            <div
              class="program-enroll__text program-enroll__text--program"
              set:html={effectiveEnrollContent}
            />
          )}

          {resolvedCtas.length > 0 && (
            <ButtonGroup
              class="program-enroll__buttons"
              actions={resolvedCtas.map((action: StructuredCta) => {
                const isExternal = action.url ? /^https?:/i.test(action.url) : false;
                return {
                  label: action.label ?? "Enroll",
                  href: action.url ?? "#",
                  variant: "primary",
                  target: isExternal ? "_blank" : undefined,
                  rel: isExternal ? "noopener noreferrer" : undefined,
                };
              })}
            />
          )}
        </div>
        {showEnrollmentGuide && enrollmentGuideHtml && (
          <CalloutCard
            class="program-enroll__callout"
            title={enrollmentGuideTitle}
            headingLevel={3}
            cta={enrollmentGuideCta}
          >
            <div class="program-enroll__callout-content" set:html={enrollmentGuideHtml} />
          </CalloutCard>
        )}
      </div>
    </Section>
  )}
</ProgramLayout>

<style>
  .program-hero__description {
    display: grid;
    gap: var(--space-md);
  }

  .program-hero__lead {
    margin: 0;
  }

  .program-hero__topics {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
  }

  .topic-pill {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.35rem 0.9rem;
    border-radius: 999px;
    background: rgba(93, 95, 239, 0.12);
    color: var(--color-text);
    font-size: 0.875rem;
  }

  .program-content {
    display: grid;
    gap: var(--space-md);
  }

  .program-classes {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: var(--space-lg);
  }

  .program-classes :global(.class-card) {
    margin-bottom: 0;
    height: 100%;
  }

  .program-enroll {
    display: grid;
    gap: var(--space-xl);
    justify-items: start;
    text-align: left;
    align-items: start;
  }

  .program-enroll__primary {
    display: grid;
    gap: var(--space-lg);
    justify-items: start;
  }

  .program-enroll__text {
    display: grid;
    gap: var(--space-sm);
    font-size: 1.05rem;
    line-height: 1.6;
    max-width: clamp(30ch, 100%, 65ch);
  }

  .program-enroll__buttons {
    justify-content: flex-start;
  }

  .program-enroll__callout {
    align-self: stretch;
  }

  .program-enroll__callout-content {
    display: grid;
    gap: var(--space-sm);
    font-size: 0.8rem;
    line-height: 1.5;
  }

  @media (max-width: 900px) {
    .program-classes {
      grid-template-columns: 1fr;
    }
  }

  @media (min-width: 960px) {
    .program-enroll--with-guide {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

</style>