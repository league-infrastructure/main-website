---
import type { GetStaticPathsResult } from "astro";
import ProgramLayout from "../../layouts/ProgramLayout.astro";
import HeroSection from "../../components/HeroSection.astro";
import Section from "../../components/Section.astro";
import SectionHeader from "../../components/SectionHeader.astro";
import { marked } from "marked";
import { getProgramsData, getClassesData } from "../../utils/markdown.js";

interface ProgramEntry {
  title: string;
  blurb?: string;
  description?: string;
  shortDescription?: string;
  content?: string;
  meta?: {
    slug?: string;
    image?: string;
    topics?: string[];
    classes?: string[];
    level?: string;
  };
  slug?: string;
  image?: string;
  topics?: string[];
  classes?: string[];
}

interface RouteProps {
  programData: ProgramEntry;
  relatedClasses: ProgramEntry[];
}

export async function getStaticPaths(): Promise<GetStaticPathsResult> {
  const programs = getProgramsData();
  const classes = getClassesData();
  return programs
    .map((entry) => {
      const slug = entry.meta?.slug ?? entry.slug;
      if (!slug) {
        return undefined;
      }

      const classSlugs = entry.meta?.classes ?? entry.classes ?? [];
      const relatedClasses = classSlugs
        .map((classSlug: string) =>
          classes.find((classItem) => (classItem.meta?.slug ?? classItem.slug) === classSlug),
        )
        .filter(Boolean) as ProgramEntry[];

      return {
        params: { slug },
        props: {
          programData: entry,
          relatedClasses,
        },
      };
    })
    .filter(Boolean) as GetStaticPathsResult;
}

const { programData, relatedClasses } = Astro.props as unknown as RouteProps;

const programSlug = programData.meta?.slug ?? programData.slug;

if (!programData || !programSlug) {
  throw new Error("Program data not found for requested slug");
}

const heroImageSource = programData.meta?.image ?? programData.image;
const heroImage = heroImageSource
  ? `/images/cards/${heroImageSource}`
  : "/images/cards/programs.png";
const heroAlt = programData.title ?? "Program hero";
const heroDescription = programData.blurb ?? programData.shortDescription;
const descriptionText =
  programData.description || programData.blurb || programData.shortDescription || "";
const descriptionParagraphs = descriptionText
  .split(/\n\s*\n/)
  .map((paragraph) => paragraph.trim())
  .filter((paragraph) => paragraph.length > 0);
const topics = programData.meta?.topics ?? programData.topics ?? [];
const hasContent = Boolean(programData.content && programData.content.trim().length > 0);
const renderedContent = hasContent ? await marked.parse(programData.content ?? "") : undefined;
---

<ProgramLayout
  title={programData.title}
  description={heroDescription ?? programData.description}
>
  <HeroSection slot="hero" class="program-hero">
    <h1 slot="tagline">{programData.title}</h1>
    {(heroDescription || topics.length > 0) && (
      <div slot="description" class="program-hero__description">
        {heroDescription && <p class="program-hero__lead">{heroDescription}</p>}
        {topics.length > 0 && (
          <div class="program-hero__topics">
            {topics.map((topic) => (
              <span class="topic-pill">{topic}</span>
            ))}
          </div>
        )}
      </div>
    )}
    <div slot="media" class="program-hero__media">
      <img src={heroImage} alt={`${heroAlt} illustration`} loading="eager" />
    </div>
  </HeroSection>

  <Section startBgcolor="var(--color-surface)" endBgcolor="var(--color-surface-alt)">
    <SectionHeader>
      <h2>Program Overview</h2>
    </SectionHeader>

    <div class="program-content">
      {renderedContent ? (
        <div class="program-content__body" set:html={renderedContent} />
      ) : descriptionParagraphs.length > 0 ? (
        descriptionParagraphs.map((paragraph) => <p>{paragraph}</p>)
      ) : (
        <p>Additional program details will be published soon.</p>
      )}
    </div>
  </Section>

  {relatedClasses.length > 0 && (
    <Section startBgcolor="var(--color-surface-alt)" endBgcolor="var(--color-primary-soft)">
      <SectionHeader>
        <h2>Classes in this Program</h2>
        <p>Explore the classes that are part of this program pathway.</p>
      </SectionHeader>

      <div class="class-gallery">
        {relatedClasses.map((classItem) => {
          const classSlug = classItem.meta?.slug ?? classItem.slug ?? "";
          const classHref = classSlug ? `/classes/${classSlug.replace(/_/g, "-")}` : undefined;
          return (
            <a href={classHref ?? "#"} class="class-gallery__item">
              <img
                src={`/images/cards/${classItem.meta?.image ?? classItem.image ?? "programs.png"}`}
                alt={classItem.title}
                loading="lazy"
              />
              <span class="class-gallery__title">{classItem.title}</span>
            </a>
          );
        })}
      </div>
    </Section>
  )}
</ProgramLayout>

<style>
  .program-hero__description {
    display: grid;
    gap: var(--space-md);
  }

  .program-hero__lead {
    margin: 0;
  }

  .program-hero__topics {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
  }

  .topic-pill {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.35rem 0.9rem;
    border-radius: 999px;
    background: rgba(93, 95, 239, 0.12);
    color: var(--color-text);
    font-size: 0.875rem;
  }

  .program-content {
    display: grid;
    gap: var(--space-md);
  }

  .class-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: var(--space-lg);
    margin-bottom: var(--space-xl);
  }

  .class-gallery__item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: var(--space-sm);
    text-decoration: none;
    color: inherit;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .class-gallery__item:hover,
  .class-gallery__item:focus-visible {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(15, 30, 73, 0.12);
  }

  .class-gallery__item img {
    width: 100%;
    border-radius: var(--radius-md);
    box-shadow: 0 8px 16px rgba(15, 30, 73, 0.1);
  }

  .class-gallery__title {
    font-weight: 600;
    font-size: 1rem;
    line-height: 1.4;
  }

</style>