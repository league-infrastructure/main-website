---
import BaseLayout from "../layouts/BaseLayout.astro";
import HeroSection from "../components/HeroSection.astro";
import Section from "../components/Section.astro";
import SectionHeader from "../components/SectionHeader.astro";
import CardGrid from "../components/CardGrid.astro";
import ProgramCard from "../components/ProgramCard.astro";
import CardBody from "../components/CardBody.astro";
import CardFooter from "../components/CardFooter.astro";
import ClassCard from "../components/ClassCard.astro";
import fs from "fs";
import path from "path";
import { parseMarkdownSections, getTopicColor } from "../utils/markdown.js";

// Read and parse the content files
const contentDir = path.resolve("./src/content");
const classesContent = fs.readFileSync(
  path.join(contentDir, "classes.md"),
  "utf-8",
);
const programsContent = fs.readFileSync(
  path.join(contentDir, "programs.md"),
  "utf-8",
);

// Parse content using utility functions
const classes = parseMarkdownSections(classesContent);
const programs = parseMarkdownSections(programsContent);

// Topic color function is imported from utils

// Function to get class details by slug
function getClassBySlug(slug: string) {
  return classes.find((c) => c.metadata.slug === slug);
}

// Function to parse class list from program
function getClassesForProgram(program: any) {
  if (!program.metadata?.classes) return [];
  return program.metadata.classes;
}
---

<BaseLayout
  title="Our Programs & Classes"
  description="Explore The League of Amazing Programmers' comprehensive coding, robotics, and engineering programs and classes designed for students from elementary through high school."
>
  <HeroSection class="programs-hero">
    <h1 slot="tagline">Our Programs & Classes</h1>
    <p slot="description">
      From beginner coding classes to advanced robotics and engineering, we
      provide comprehensive STEM education pathways for students of all skill
      levels.
    </p>
    <div slot="media" class="programs-hero__media">
      <img
        src="/images/cards/programs.png"
        alt="Students learning programming and robotics"
        loading="eager"
      />
    </div>
  </HeroSection>

  <!-- Programs Section -->
  <Section
    startBgcolor="var(--color-surface)"
    endBgcolor="var(--color-primary-soft)"
  >
    <SectionHeader>
      <h2>Programs</h2>
      <p>
        Comprehensive learning pathways and specialized program offerings that
        guide students through structured educational experiences.
      </p>
    </SectionHeader>

    <CardGrid>
      {
        programs.map((program) => {
          const programClasses = getClassesForProgram(program);
          return (
            <ProgramCard
              img={`/images/cards/${program.metadata.image}`}
              alt={program.title}
            >
              <CardBody>
                <h3>{program.title}</h3>
                <p>{program.shortDescription}</p>
              </CardBody>
              <CardFooter>
                {programClasses.length > 0 && (
                  <div class="class-lozenges">
                    <p class="lozenges-label">Classes in this program:</p>
                    <div class="lozenges-container">
                      {programClasses.map((classSlug: string) => {
                        const classItem = getClassBySlug(classSlug);
                        if (classItem) {
                          return (
                            <a
                              href={`#class-${classSlug}`}
                              class="class-lozenge"
                              style={`background-color: ${getTopicColor(classItem.metadata.topics)}`}
                            >
                              {classItem.title}
                            </a>
                          );
                        }
                        return null;
                      })}
                    </div>
                  </div>
                )}
              </CardFooter>
            </ProgramCard>
          );
        })
      }
    </CardGrid>
  </Section>

  <!-- Classes Section -->
  <Section
    startBgcolor="var(--color-primary-soft)"
    endBgcolor="var(--color-secondary-soft)"
  >
    <SectionHeader>
      <h2>Classes</h2>
      <p>
        Individual classes and workshops focused on specific programming
        languages, technologies, and skills.
      </p>
    </SectionHeader>

    <div class="classes-list">
      {
        classes.map((classItem) => (
          <ClassCard
            img={`/images/cards/${classItem.metadata.image}`}
            alt={classItem.title}
            slug={classItem.metadata.slug}
            title={classItem.title}
            level={classItem.metadata.level}
            description={classItem.shortDescription}
          />
        ))
      }
    </div>
  </Section>

  <!-- Program Information -->
  <Section
    startBgcolor="var(--color-surface)"
    endBgcolor="var(--color-surface-alt)"
  >
    <SectionHeader>
      <h2>Program Information</h2>
    </SectionHeader>

    <div class="program-info-grid">
      <div class="info-card">
        <h3>üéØ All Skill Levels</h3>
        <p>
          From complete beginners to advanced students, we have programs
          designed for every skill level and learning pace.
        </p>
      </div>

      <div class="info-card">
        <h3>üè´ Multiple Locations</h3>
        <p>
          Programs available at 30+ sites across San Diego County including
          schools, libraries, and community centers.
        </p>
      </div>

      <div class="info-card">
        <h3>üíª Industry Tools</h3>
        <p>
          Learn with professional development tools and industry-standard
          programming languages used by real software developers.
        </p>
      </div>

      <div class="info-card">
        <h3>üë• Small Class Sizes</h3>
        <p>
          Personalized attention with small class sizes ensuring every student
          gets the support they need to succeed.
        </p>
      </div>

      <div class="info-card">
        <h3>üéì Portfolio Development</h3>
        <p>
          Build a comprehensive portfolio of projects that showcases your skills
          to colleges and future employers.
        </p>
      </div>

      <div class="info-card">
        <h3>ü§ù Community Focus</h3>
        <p>
          Join a supportive community of learners, mentors, and technology
          enthusiasts committed to inclusive STEM education.
        </p>
      </div>
    </div>
  </Section>

  <!-- Call to Action -->
  <Section
    startBgcolor="var(--color-surface-alt)"
    endBgcolor="var(--color-primary-soft)"
  >
    <SectionHeader>
      <h2>Ready to Start Learning?</h2>
      <p>
        Explore our programs and find the perfect fit for your interests and
        skill level.
      </p>
    </SectionHeader>

    <div class="cta-grid">
      <div class="cta-card">
        <h3>Browse All Classes</h3>
        <p>See our complete schedule of weekly classes and ongoing programs.</p>
        <a href="/programs/java" class="cta-button">View Classes</a>
      </div>

      <div class="cta-card">
        <h3>Join Tech Club</h3>
        <p>
          Start with our free community coding sessions. No experience required!
        </p>
        <a href="/programs/tech-club" class="cta-button">Join Tech Club</a>
      </div>

      <div class="cta-card">
        <h3>Get Help Now</h3>
        <p>
          Need immediate support with a project? Our Code Clinic is here to
          help.
        </p>
        <a href="/programs/code-clinic" class="cta-button">Get Support</a>
      </div>
    </div>
  </Section>
</BaseLayout>

<style>
  :root {
    --color-python: #306998;
    --color-java: #f89820;
    --color-robotics: #e74c3c;
    --color-electronics: #9b59b6;
    --color-games: #2ecc71;
    --color-web: #3498db;
    --color-default: #95a5a6;
  }

  .class-level {
    font-size: 0.9em;
    color: var(--color-text-muted);
    margin-top: 0.5rem;
  }

  /* Program card image styling */
  :global(.card img) {
    object-fit: contain;
    object-position: center;
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    display: block;
  }

  /* Program card class lozenges */
  .class-lozenges {
    width: 100%;
    margin: 0 0 1rem 0;
  }

  .card__footer .class-lozenges {
    align-self: stretch;
  }

  .lozenges-label {
    font-size: 0.9em;
    font-weight: 600;
    color: var(--color-text-muted);
    margin-bottom: 0.5rem;
  }

  .lozenges-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: flex-start;
  }

  .class-lozenge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    color: white;
    text-decoration: none;
    font-size: 0.8rem;
    font-weight: 500;
    transition:
      opacity 0.2s ease,
      transform 0.2s ease;
  }

  .class-lozenge:hover {
    opacity: 0.8;
    transform: translateY(-1px);
  }

  /* Classes list styles */
  .classes-list {
    max-width: 800px;
    margin: 0 auto;
  }

  /* Class cards are now self-contained components */

  .programs-hero {
    background: linear-gradient(
      135deg,
      var(--color-primary-soft) 0%,
      var(--color-surface) 100%
    );
  }

  .programs-hero__media img {
    max-width: 400px;
    height: auto;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-card);
  }

  .program-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-xl);
  }

  .info-card {
    background: var(--color-surface);
    padding: var(--space-xl);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-card);
    text-align: center;
  }

  .info-card h3 {
    color: var(--color-primary);
    margin-bottom: var(--space-md);
    font-size: 1.25rem;
  }

  .info-card p {
    color: var(--color-body);
    line-height: 1.6;
  }

  .cta-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-xl);
  }

  .cta-card {
    background: var(--color-surface);
    padding: var(--space-xl);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-card);
    text-align: center;
  }

  .cta-card h3 {
    color: var(--color-primary);
    margin-bottom: var(--space-md);
    font-size: 1.3rem;
  }

  .cta-card p {
    color: var(--color-body);
    margin-bottom: var(--space-lg);
    line-height: 1.6;
  }

  .cta-button {
    display: inline-block;
    background: var(--color-primary);
    color: white;
    padding: var(--space-md) var(--space-xl);
    border-radius: var(--radius-sm);
    text-decoration: none;
    font-weight: 600;
    transition: background-color 0.2s ease;
  }

  .cta-button:hover {
    background: var(--color-primary-dark);
  }

  @media (max-width: 768px) {
    .program-info-grid,
    .cta-grid {
      grid-template-columns: 1fr;
    }

    .programs-hero__media img {
      max-width: 100%;
    }
  }
</style>
