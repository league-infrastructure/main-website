---
import BaseLayout from "../layouts/BaseLayout.astro";
import HeroSection from "../components/HeroSection.astro";
import Section from "../components/Section.astro";
import SectionHeader from "../components/SectionHeader.astro";
import CardGrid from "../components/CardGrid.astro";
import ProgramCard from "../components/ProgramCard.astro";
import CardBody from "../components/CardBody.astro";
import CardFooter from "../components/CardFooter.astro";
import ButtonGroup from "../components/ButtonGroup.astro";
import ClassCard from "../components/ClassCard.astro";
import {
  getClassesData,
  getProgramsData,
  getCategoriesData,
  getTopicColor,
} from "../utils/markdown.js";

const classes = getClassesData();
const programs = getProgramsData();
const categories = getCategoriesData();

type CategoryButton = { label?: string; url?: string; type?: string };

const categoryLookup = new Map(
  categories
    .map((category) => {
      const slug = category.slug ?? category.meta?.slug;
      return slug ? [slug, category] : undefined;
    })
    .filter(Boolean) as Array<[string, typeof categories[number]]>
);

const categorySections = [
  { slug: "group-classes", fallbackTitle: "Weekly Classes" },
  { slug: "community-tech", fallbackTitle: "Community Programs" },
];

// Topic color function is imported from utils

// Function to get class details by slug
function getClassBySlug(slug: string) {
  return classes.find((c) => (c.slug ?? c.meta?.slug) === slug);
}

// Function to parse class list from program
function getClassesForProgram(program: any) {
  const classList = program.classes ?? program.meta?.classes;
  return Array.isArray(classList) ? classList : [];
}

function getProgramsForCategory(slug: string) {
  return programs.filter((program) => {
    const programCategories =
      (Array.isArray(program.category) && program.category.length > 0
        ? program.category
        : Array.isArray(program.meta?.category)
          ? program.meta.category
          : []) ?? [];
    return programCategories.includes(slug);
  });
}
---

<BaseLayout
  title="Our Programs & Classes"
  description="Explore The League of Amazing Programmers' comprehensive coding, robotics, and engineering programs and classes designed for students from elementary through high school."
>
  <HeroSection class="programs-hero">
    <h1 slot="tagline">Our Programs & Classes</h1>
    <p slot="description">
      From beginner coding classes to advanced robotics and engineering, we
      provide comprehensive STEM education pathways for students of all skill
      levels.
    </p>
    <div slot="media" class="programs-hero__media">
      <img
        src="/images/cards/programs.png"
        alt="Students learning programming and robotics"
        loading="eager"
      />
    </div>
  </HeroSection>

  {
    categorySections.map(({ slug, fallbackTitle }, index) => {
      const categoryData = categoryLookup.get(slug);
      const sectionPrograms = getProgramsForCategory(slug);
      const buttons = (categoryData?.buttons ?? categoryData?.meta?.buttons ?? []) as CategoryButton[];
      const validButtons = buttons.filter((button) => button?.label && button?.url);
      const enrollContent = categoryData?.enroll?.trim();

      if (sectionPrograms.length === 0) {
        return null;
      }

      const sectionTitle = categoryData?.title ?? fallbackTitle;
      const sectionDescription = categoryData?.blurb ?? categoryData?.description;
      const backgroundPresets = [
        { start: "var(--color-surface)", end: "var(--color-primary-soft)" },
        { start: "var(--color-primary-soft)", end: "var(--color-secondary-soft)" },
      ];
      const colors = backgroundPresets[index % backgroundPresets.length];

      return (
        <Section startBgcolor={colors.start} endBgcolor={colors.end} data-category={slug}>
          <SectionHeader>
            <h2>{sectionTitle}</h2>
            {sectionDescription && <p>{sectionDescription}</p>}
          </SectionHeader>

          <CardGrid>
            {sectionPrograms
              .map((program) => {
              const programClasses = getClassesForProgram(program);
              const programSlug = program.slug ?? program.meta?.slug;
              const programUrl = programSlug ? `/programs/${programSlug}` : undefined;
              const programImage = program.image ?? program.meta?.image;
              if (!programImage) {
                console.warn(`Program "${program.title}" is missing an image.`);
                return null;
              }
              return (
                <ProgramCard
                  img={`/images/cards/${programImage}`}
                  alt={program.title}
                  href={programUrl}
                >
                  <CardBody>
                    <h3>
                      {programUrl ? (
                        <a href={programUrl} class="program-card__title-link">
                          {program.title}
                        </a>
                      ) : (
                        program.title
                      )}
                    </h3>
                    <p>{program.blurb ?? program.description}</p>
                  </CardBody>
                  <CardFooter>
                    {programClasses.length > 0 && (
                      <div class="class-lozenges">
                        <p class="lozenges-label">Classes in this program:</p>
                        <div class="lozenges-container">
                          {programClasses.map((classSlug: string) => {
                            const classItem = getClassBySlug(classSlug);
                            if (classItem) {
                              const classTopics = Array.isArray(classItem.topics)
                                ? classItem.topics
                                : Array.isArray(classItem.meta?.topics)
                                  ? classItem.meta.topics
                                  : [];
                              const targetSlug = classItem.slug ?? classItem.meta?.slug ?? classSlug;
                              return (
                                <a
                                  href={`#class-${targetSlug}`}
                                  class="class-lozenge"
                                  style={`background-color: ${getTopicColor(classTopics)}`}
                                >
                                  {classItem.title}
                                </a>
                              );
                            }
                            return null;
                          })}
                        </div>
                      </div>
                    )}
                    {programUrl && (
                      <a
                        slot="learn-more"
                        href={programUrl}
                        class="program-card__learn-more-link"
                      >
                        Learn more
                      </a>
                    )}
                  </CardFooter>
                </ProgramCard>
              );
              })
              .filter(Boolean)}
          </CardGrid>

          {(enrollContent || validButtons.length > 0) && (
            <div class="category-enroll">
              {enrollContent && (
                <div class="category-enroll__text" set:html={enrollContent} />
              )}
              {validButtons.length > 0 && (
                <ButtonGroup
                  class="category-enroll__buttons"
                  actions={validButtons.map((button) => {
                    const isExternal = button.url ? /^https?:/i.test(button.url) : false;
                    return {
                      label: button.label ?? "Learn more",
                      href: button.url ?? "#",
                      variant: "primary",
                      target: isExternal ? "_blank" : undefined,
                      rel: isExternal ? "noopener noreferrer" : undefined,
                    };
                  })}
                />
              )}
            </div>
          )}
        </Section>
      );
    })
  }

  <!-- Classes Section -->
  <Section
    startBgcolor="var(--color-primary-soft)"
    endBgcolor="var(--color-secondary-soft)"
  >
    <SectionHeader>
      <h2>Class Catalog</h2>
      <p>
        Individual classes and workshops focused on specific programming
        languages, technologies, and skills.
      </p>
    </SectionHeader>

    <div class="classes-list">
      {
        classes
          .map((classItem) => {
            const classSlug = classItem.slug ?? classItem.meta?.slug;
            const classImage = classItem.image ?? classItem.meta?.image;
            const classLevel = classItem.level ?? classItem.meta?.level;
            if (!classSlug || !classImage) {
              console.warn(`Class "${classItem.title}" is missing slug or image.`);
              return null;
            }
            return (
              <ClassCard
                img={`/images/cards/${classImage}`}
                alt={classItem.title}
                slug={classSlug}
                title={classItem.title}
                level={classLevel}
                description={classItem.blurb ?? classItem.description ?? ""}
              />
            );
          })
          .filter(Boolean)
      }
    </div>
  </Section>

  <!-- Program Information -->
  <Section
    startBgcolor="var(--color-surface)"
    endBgcolor="var(--color-surface-alt)"
  >
    <SectionHeader>
      <h2>Program Information</h2>
    </SectionHeader>

    <div class="program-info-grid">
      <div class="info-card">
        <h3>üéØ All Skill Levels</h3>
        <p>
          From complete beginners to advanced students, we have programs
          designed for every skill level and learning pace.
        </p>
      </div>

      <div class="info-card">
        <h3>üè´ Multiple Locations</h3>
        <p>
          Programs available at 30+ sites across San Diego County including
          schools, libraries, and community centers.
        </p>
      </div>

      <div class="info-card">
        <h3>üíª Industry Tools</h3>
        <p>
          Learn with professional development tools and industry-standard
          programming languages used by real software developers.
        </p>
      </div>

      <div class="info-card">
        <h3>üë• Small Class Sizes</h3>
        <p>
          Personalized attention with small class sizes ensuring every student
          gets the support they need to succeed.
        </p>
      </div>

      <div class="info-card">
        <h3>üéì Portfolio Development</h3>
        <p>
          Build a comprehensive portfolio of projects that showcases your skills
          to colleges and future employers.
        </p>
      </div>

      <div class="info-card">
        <h3>ü§ù Community Focus</h3>
        <p>
          Join a supportive community of learners, mentors, and technology
          enthusiasts committed to inclusive STEM education.
        </p>
      </div>
    </div>
  </Section>

  <!-- Call to Action -->
  <Section
    startBgcolor="var(--color-surface-alt)"
    endBgcolor="var(--color-primary-soft)"
  >
    <SectionHeader>
      <h2>Ready to Start Learning?</h2>
      <p>
        Explore our programs and find the perfect fit for your interests and
        skill level.
      </p>
    </SectionHeader>

    <div class="cta-grid">
      <div class="cta-card">
        <h3>Browse All Classes</h3>
        <p>See our complete schedule of weekly classes and ongoing programs.</p>
        <a href="/programs/java" class="cta-button">View Classes</a>
      </div>

      <div class="cta-card">
        <h3>Join Tech Club</h3>
        <p>
          Start with our free community coding sessions. No experience required!
        </p>
        <a href="/programs/tech-club" class="cta-button">Join Tech Club</a>
      </div>

      <div class="cta-card">
        <h3>Get Help Now</h3>
        <p>
          Need immediate support with a project? Our Code Clinic is here to
          help.
        </p>
        <a href="/programs/code-clinic" class="cta-button">Get Support</a>
      </div>
    </div>
  </Section>
</BaseLayout>

<style>
  :root {
    --color-python: #306998;
    --color-java: #f89820;
    --color-robotics: #e74c3c;
    --color-electronics: #9b59b6;
    --color-games: #2ecc71;
    --color-web: #3498db;
    --color-default: #95a5a6;
  }

  .class-level {
    font-size: 0.9em;
    color: var(--color-text-muted);
    margin-top: 0.5rem;
  }

  /* Program card image styling */
  :global(.card img) {
    object-fit: contain;
    object-position: center;
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    display: block;
  }

  /* Program card class lozenges */
  .class-lozenges {
    width: 100%;
    margin: 0 0 1rem 0;
  }

  .card__footer .class-lozenges {
    align-self: stretch;
  }

  .lozenges-label {
    font-size: 0.9em;
    font-weight: 600;
    color: var(--color-text-muted);
    margin-bottom: 0.5rem;
  }

  .lozenges-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: flex-start;
  }

  .class-lozenge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    color: white;
    text-decoration: none;
    font-size: 0.8rem;
    font-weight: 500;
    transition:
      opacity 0.2s ease,
      transform 0.2s ease;
  }

  .class-lozenge:hover {
    opacity: 0.8;
    transform: translateY(-1px);
  }

  .category-enroll {
    display: grid;
    gap: var(--space-lg);
    margin-top: var(--space-xl);
    text-align: center;
  }

  .category-enroll__text {
    font-size: 1.05rem;
    line-height: 1.6;
    color: var(--color-body);
  }

  .category-enroll__buttons {
    justify-content: center;
  }

  .program-card__title-link {
    color: inherit;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .program-card__title-link:hover {
    color: var(--color-primary-dark);
  }

  .program-card__learn-more-link {
    font-weight: 600;
    color: var(--color-primary);
    text-decoration: none;
    transition:
      color 0.2s ease,
      text-decoration-color 0.2s ease;
    display: inline-flex;
    justify-content: center;
    width: fit-content;
  }

  .program-card__learn-more-link:hover {
    color: var(--color-primary-dark);
    text-decoration: underline;
  }

  /* Classes list styles */
  .classes-list {
    max-width: 800px;
    margin: 0 auto;
  }

  /* Class cards are now self-contained components */

  .programs-hero {
    background: linear-gradient(
      135deg,
      var(--color-primary-soft) 0%,
      var(--color-surface) 100%
    );
  }

  .programs-hero__media img {
    max-width: 400px;
    height: auto;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-card);
  }

  .program-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-xl);
  }

  .info-card {
    background: var(--color-surface);
    padding: var(--space-xl);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-card);
    text-align: center;
  }

  .info-card h3 {
    color: var(--color-primary);
    margin-bottom: var(--space-md);
    font-size: 1.25rem;
  }

  .info-card p {
    color: var(--color-body);
    line-height: 1.6;
  }

  .cta-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-xl);
  }

  .cta-card {
    background: var(--color-surface);
    padding: var(--space-xl);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-card);
    text-align: center;
  }

  .cta-card h3 {
    color: var(--color-primary);
    margin-bottom: var(--space-md);
    font-size: 1.3rem;
  }

  .cta-card p {
    color: var(--color-body);
    margin-bottom: var(--space-lg);
    line-height: 1.6;
  }

  .cta-button {
    display: inline-block;
    background: var(--color-primary);
    color: white;
    padding: var(--space-md) var(--space-xl);
    border-radius: var(--radius-sm);
    text-decoration: none;
    font-weight: 600;
    transition: background-color 0.2s ease;
  }

  .cta-button:hover {
    background: var(--color-primary-dark);
  }

  @media (max-width: 768px) {
    .program-info-grid,
    .cta-grid {
      grid-template-columns: 1fr;
    }

    .programs-hero__media img {
      max-width: 100%;
    }
  }
</style>

<script is:inline>
  if (typeof window !== "undefined") {
    const cards = Array.from(
      document.querySelectorAll(
        ".card-grid .program-card",
      ),
    );

    if (cards.length > 0) {
      const getRowKey = (element) =>
        Math.round(element.getBoundingClientRect().top);

      const applyHeights = () => {
        const rowCardHeights = new Map();
        const rowFooterHeights = new Map();

        cards.forEach((card) => {
          card.style.minHeight = "";
          const footer = card.querySelector(".card__footer");
          if (footer) {
            footer.style.minHeight = "";
          }
        });

        cards.forEach((card) => {
          const rowKey = getRowKey(card);
          const currentCardTallest = rowCardHeights.get(rowKey) || 0;
          rowCardHeights.set(rowKey, Math.max(currentCardTallest, card.offsetHeight));

          const footer = card.querySelector(".card__footer");
          if (!footer) return;
          const currentFooterTallest = rowFooterHeights.get(rowKey) || 0;
          rowFooterHeights.set(
            rowKey,
            Math.max(currentFooterTallest, footer.offsetHeight),
          );
        });

        cards.forEach((card) => {
          const rowKey = getRowKey(card);
          const targetCardHeight = rowCardHeights.get(rowKey);
          if (targetCardHeight) {
            card.style.minHeight = `${targetCardHeight}px`;
          }

          const footer = card.querySelector(".card__footer");
          if (!footer) return;
          const targetFooterHeight = rowFooterHeights.get(rowKey);
          if (targetFooterHeight) {
            footer.style.minHeight = `${targetFooterHeight}px`;
          }
        });
      };

      const footerObserver = new ResizeObserver(() => applyHeights());
      const cardObserver = new ResizeObserver(() => applyHeights());

      cards.forEach((card) => {
        const footer = card.querySelector(".card__footer");
        if (footer) footerObserver.observe(footer);
        cardObserver.observe(card);
      });

      const handleResize = () => {
        window.requestAnimationFrame(applyHeights);
      };

      window.addEventListener("load", applyHeights);
      window.addEventListener("resize", handleResize);
      applyHeights();

      window.addEventListener(
        "pagehide",
        () => {
          footerObserver.disconnect();
          cardObserver.disconnect();
          window.removeEventListener("resize", handleResize);
          window.removeEventListener("load", applyHeights);
        },
        { once: true },
      );
    }
  }
</script>
