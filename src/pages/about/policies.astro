---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Section from "../../components/Section.astro";
import SectionHeader from "../../components/SectionHeader.astro";
import HeroSection from "../../components/HeroSection.astro";
import PolicyTopicCards from "../../components/PolicyTopicCards.astro";
import ButtonGroup from "../../components/ButtonGroup.astro";
import { marked } from "marked";
import { getPoliciesData } from "../../utils/markdown.js";
import type { StructuredContentRecord, StructuredCta } from "../../types/content";

const rawPolicies = getPoliciesData() as StructuredContentRecord[];

const slugify = (value: string) =>
  value
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "")
    .trim();

const splitParagraphs = (text?: string | null) =>
  typeof text === "string"
    ? text
        .split(/\n\s*\n/)
        .map((paragraph) => paragraph.trim())
        .filter((paragraph) => paragraph.length > 0)
    : [];

const toButtonVariant = (value?: string): "primary" | "secondary" | "outline" | "ghost" => {
  switch (value) {
    case "primary":
    case "secondary":
    case "outline":
    case "ghost":
      return value;
    default:
      return "ghost";
  }
};

const processedPolicies = await Promise.all(
  rawPolicies.map(async (policy, index) => {
    const baseSlug = policy.slug ?? policy.meta?.slug ?? slugify(policy.title ?? "");
    const fallbackId = `policy-${index + 1}`;
    const id = (baseSlug ? slugify(baseSlug) : slugify(policy.title ?? "")) || fallbackId;

    const descriptionParagraphs = splitParagraphs(policy.description ?? policy.fullDescription);
    const contentHtml = policy.content ? await marked.parse(policy.content) : "";
    const summaryText = (policy.blurb ?? descriptionParagraphs[0] ?? "").trim();

    const rawCtas = Array.isArray(policy.cta)
      ? policy.cta
      : Array.isArray(policy.meta?.cta)
        ? policy.meta.cta
        : [];

    const ctas = rawCtas
      .filter((action): action is StructuredCta => Boolean(action?.label && action?.url))
      .map((action) => ({
        ...action,
        variant: action?.variant ?? "ghost",
      }));

    return {
      id,
      title: policy.title ?? `Policy ${index + 1}`,
      summary: summaryText,
      descriptionParagraphs,
      contentHtml,
      ctas,
      background: index % 2 === 1 ? "var(--color-surface-alt)" : undefined,
    };
  }),
);

const policies = processedPolicies.filter((policy) => policy.title && (policy.contentHtml || policy.descriptionParagraphs.length > 0));
const hasPolicies = policies.length > 0;
---

<BaseLayout
  title="Policies & Procedures"
  description="Review The League of Amazing Programmers policies on tuition, payments, make-ups, cancellations, and enrollment."
>
  <HeroSection
    class="policies-hero"
    actions={[
      {
        label: "Client Portal",
        href: "https://jtl.pike13.com/accounts/sign_in",
        variant: "primary" as const,
        target: "_blank",
        rel: "noreferrer",
      },
    ]}
  >
    <h1 slot="title">Policies &amp; Procedures</h1>
    <p slot="description">
      LEAGUE policies outline how tuition, memberships, attendance, and communication work across
      our programs. Most tasks can be completed through the Client Portal using the button below.
    </p>
    <img
      slot="media"
      src="/images/cards/current_students.png"
      alt="Students collaborating at The League"
      loading="lazy"
    />
  </HeroSection>

  <Section class="policy-links">
    <SectionHeader align="left">
      <h2>Explore Policy Topics</h2>
      <p>
        Jump to common tuition and enrollment questions or review our detailed policy guides.
      </p>
    </SectionHeader>
    <PolicyTopicCards />
  </Section>

  {hasPolicies ? (
  policies.map((policy) => (
      <Section
        class="policy-section"
        data-policy-section
        data-policy-title={policy.title}
        data-policy-summary={policy.summary}
        id={policy.id}
        {...(policy.background ? { bgcolor: policy.background } : {})}
      >
        <div class="policy-section__header">
          <h2>{policy.title}</h2>
          {policy.summary && <p class="policy-section__summary">{policy.summary}</p>}
        </div>

        {policy.descriptionParagraphs.length > 0 && (
          <div class="policy-section__description">
            {policy.descriptionParagraphs.map((paragraph) => (
              <p>{paragraph}</p>
            ))}
          </div>
        )}

        {policy.contentHtml && (
          <div class="policy-section__content" set:html={policy.contentHtml} />
        )}

        {policy.ctas.length > 0 && (
          <ButtonGroup
            class="policy-section__actions"
            actions={policy.ctas.map((action: StructuredCta) => {
              const isExternal = action.url ? /^https?:/i.test(action.url) : false;
              return {
                label: action.label ?? "Learn more",
                href: action.url ?? "#",
                variant: toButtonVariant(action.variant),
                target: isExternal ? "_blank" : action.target,
                rel: isExternal ? "noopener noreferrer" : action.rel,
              };
            })}
          />
        )}
      </Section>
    ))
  ) : (
    <Section class="policy-section policy-section--empty">
      <SectionHeader>
        <h2>Policy updates are on the way</h2>
        <p>Check back soon for the latest policies and procedures.</p>
      </SectionHeader>
    </Section>
  )}
</BaseLayout>

<style>
  .policy-links {
    display: grid;
    gap: var(--space-xl);
  }

  .policy-section {
    display: grid;
    gap: var(--space-lg);
  }

  .policy-section__header {
    display: grid;
    gap: var(--space-sm);
  }

  .policy-section__summary {
    margin: 0;
    color: var(--color-body-muted, #475467);
  }

  .policy-section__description {
    display: grid;
    gap: var(--space-md);
  }

  .policy-section__content {
    display: grid;
    gap: var(--space-md);
  }

  .policy-section__content ul,
  .policy-section__content ol {
    padding-left: var(--space-lg);
  }

  .policy-section__actions {
    justify-content: flex-start;
    flex-wrap: wrap;
    gap: var(--space-md);
  }

  .policy-section--empty {
    text-align: center;
  }

  .policy-section__actions :global(a) {
    min-width: 190px;
  }

  @media (max-width: 720px) {
    .policy-section__actions {
      justify-content: center;
    }
  }
</style>
