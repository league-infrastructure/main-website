---
import BaseLayout from './BaseLayout.astro';
import Post from '../components/Post.astro';
const assetModules = import.meta.glob('../content/posts/**/*.{png,jpg,jpeg,gif,webp,avif,svg}', {
  eager: true,
}) as Record<string, { default: string }>;

interface FeaturedImage {
  src: string;
  alt?: string | null;
  caption?: string | null;
  srcset?: string | null;
  sizes?: string | null;
}

interface Frontmatter {
  title?: string | null;
  author?: string | null;
  date?: string | null;
  description?: string | null;
  featuredImage?: FeaturedImage | string | null;
  featuredImageAlt?: string | null;
  slug?: string | null;
}

interface Props {
  frontmatter: Frontmatter;
}

const { frontmatter } = Astro.props as Props;
const {
  title,
  author = null,
  date = null,
  description = null,
  featuredImage = null,
  featuredImageAlt = null,
  slug = null,
} = frontmatter;

const pageTitle = title ?? 'League Update';
const resolveImageSource = (value: string | undefined | null) => {
  if (!value) {
    return null;
  }

  if (value.startsWith('http')) {
    return value;
  }

  if (value.startsWith('./') && slug) {
    const cleaned = value.replace(/^\.\//, '');
    const key = `../content/posts/${slug}/${cleaned}`;
    const asset = assetModules[key];
    if (asset && asset.default) {
      return asset.default;
    }
    return null;
  }

  return value;
};

const normalizedFeaturedImage = (() => {
  if (!featuredImage) {
    return null;
  }

  if (typeof featuredImage === 'string') {
    const resolved = resolveImageSource(featuredImage);
    if (!resolved) {
      return null;
    }
    return { src: resolved, alt: featuredImageAlt ?? pageTitle } satisfies FeaturedImage;
  }

  const resolved = resolveImageSource(featuredImage.src);
  if (!resolved) {
    return null;
  }

  return {
    src: resolved,
    alt: featuredImage.alt ?? featuredImageAlt ?? pageTitle,
    caption: featuredImage.caption ?? undefined,
  } satisfies FeaturedImage;
})();

---

<BaseLayout title={pageTitle} description={description ?? undefined}>
  <Post
    title={pageTitle}
    author={author ?? undefined}
    date={date ?? undefined}
    featuredImage={normalizedFeaturedImage ?? undefined}
  >
    <slot />
  </Post>
</BaseLayout>
